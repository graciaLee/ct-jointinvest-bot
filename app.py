from flask import Flask, request, jsonify, send_from_directory, session, redirect, url_for

app = Flask(__name__, static_folder=".")

# ì„¸ì…˜ìš© ë¹„ë°€í‚¤ (ì‹¤ì‚¬ìš© ì‹œì—ëŠ” ë³µì¡í•œ ëœë¤ ë¬¸ìì—´ë¡œ ë°˜ë“œì‹œ ë³€ê²½!)
app.secret_key = "CHANGE_THIS_TO_A_RANDOM_SECRET_KEY"

# ğŸ” ë¡œê·¸ì¸ í—ˆìš© ì‚¬ìš©ì ëª©ë¡ (ì›í•˜ëŠ” ëŒ€ë¡œ ìˆ˜ì •)
ALLOWED_USERS = {
    "ctuser1": "pass1234",
    "ctuser2": "pass5678",
}

# ğŸ§  ìì—°ì–´ ë§¤ì¹­ìš© "ì˜ë¯¸ íƒœê·¸"ì™€ ê·¸ì— í•´ë‹¹í•˜ëŠ” í‘œí˜„ë“¤(ë™ì˜ì–´Â·ìœ ì‚¬ í‘œí˜„ë“¤)
SYNONYM_GROUPS = {
    # ê°œë…: í•©ë™ì¡°ì‚¬ ìì²´
    "JOINT_INVESTIGATION": [
        "í•©ë™ì¡°ì‚¬", "í•©ë™ ì¡°ì‚¬", "ê³µë™ì¡°ì‚¬", "ê³µë™ ì¡°ì‚¬",
        "ëŒ€í…ŒëŸ¬ ì¡°ì‚¬", "ì—¬ëŸ¬ ê¸°ê´€ ê°™ì´ ì¡°ì‚¬", "í•©ë™ ìˆ˜ì‚¬"
    ],
    # ì–¸ì œ/ì¡°ê±´/í•„ìš”ì„±
    "WHEN": ["ì–¸ì œ", "ì‹œì ", "ì–¸ì œ í•˜ëŠ”ì§€", "í•„ìš”í•  ë•Œ", "í•„ìš”í•œ ìƒí™©", "ì¡°ê±´"],
    # ì ˆì°¨/ë‹¨ê³„/ë°©ë²•/ì§„í–‰
    "PROCEDURE": ["ì ˆì°¨", "ë‹¨ê³„", "ì§„í–‰", "ì–´ë–»ê²Œ", "ë°©ë²•", "ê³¼ì •", "í”Œë¡œìš°", "ìˆœì„œ"],
    # ì´ˆë™ ëŒ€ì‘
    "INITIAL_RESPONSE": [
        "ì´ˆë™", "ì´ˆê¸° ëŒ€ì‘", "ì²« ëŒ€ì‘", "ì²˜ìŒì—", "ì²«ë²ˆì§¸ë¡œ", "ìš°ì„ ", "í˜„ì¥ ë„ì°©",
        "ì²˜ìŒ í•  ì¼", "ë¨¼ì € í•´ì•¼", "ë§¨ ë¨¼ì €"
    ],
    # ì—°ë½/ì „í™”/ì‹ ê³ 
    "CONTACT": [
        "ì—°ë½", "ì „í™”", "ì‹ ê³ ", "ë²ˆí˜¸", "ì–´ë””ì—", "ëˆ„êµ¬í•œí…Œ", "ëˆ„êµ¬ì—ê²Œ", "ì–´ë””ë¡œ",
        "ë‹´ë‹¹ì"
    ],
    # ì² ë„/ì—­/ìŠ¹ê°•ì¥
    "RAIL": [
        "ì² ë„", "ê¸°ì°¨", "ì—­", "ì² ë„ì—­", "ìŠ¹ê°•ì¥", "í”Œë«í¼", "ê¸°ì°¨ì—­", "ì§€í•˜ì² ì—­"
    ],
    # í­ë°œë¬¼/í­íƒ„/ìˆ˜ìƒí•œ ê°€ë°©
    "EXPLOSIVE": [
        "í­ë°œë¬¼", "í­íƒ„", "ìˆ˜ìƒí•œ ê°€ë°©", "ìˆ˜ìƒí•œ ë¬¼ê±´", "ì˜ì‹¬ë¬¼",
        "ì˜ì‹¬ìŠ¤ëŸ¬ìš´ ê°€ë°©", "í­ë°œ", "í­ë°œ ê°€ëŠ¥", "ì‚ ì†Œë¦¬", "ìœ„í—˜í•œ ê°€ë°©"
    ],
    # ê³µí•­/ìˆ˜í•˜ë¬¼
    "AIRPORT": [
        "ê³µí•­", "ê³µí•­ í„°ë¯¸ë„", "í•­ê³µì‚¬", "íƒ‘ìŠ¹ìˆ˜ì†", "ë³´ì•ˆê²€ìƒ‰", "ìˆ˜í•˜ë¬¼", "ì§ ê²€ìƒ‰"
    ],
    # í•­ë§Œ/ì»¨í…Œì´ë„ˆ
    "HARBOR": [
        "í•­ë§Œ", "í•­êµ¬", "ë¶€ë‘", "ì„ ì„", "ì»¨í…Œì´ë„ˆ", "ì»¨í…Œì´ë„ˆ ì•¼ë“œ", "CY", "í„°ë¯¸ë„"
    ],
}


def normalize_text(text):
    """ê°„ë‹¨í•œ ì „ì²˜ë¦¬: ì†Œë¬¸ìí™” + ê³µë°± ì •ë¦¬ (ì˜ì–´ ì„ì¼ ë•Œ ëŒ€ë¹„ìš©)"""
    return " ".join(text.lower().split())


def text_has_tag(text, tag):
    """ì‚¬ìš©ì ì…ë ¥(text)ì— íŠ¹ì • ì˜ë¯¸ íƒœê·¸(tag)ì— í•´ë‹¹í•˜ëŠ” í‘œí˜„ì´ í•˜ë‚˜ë¼ë„ ë“¤ì–´ìˆìœ¼ë©´ True"""
    if tag not in SYNONYM_GROUPS:
        return False
    for word in SYNONYM_GROUPS[tag]:
        if word in text:
            return True
    return False


def get_tags_in_text(text):
    """ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì–´ë–¤ ì˜ë¯¸ íƒœê·¸ë“¤ì´ ê°ì§€ë˜ëŠ”ì§€ ì§‘í•©ìœ¼ë¡œ ë°˜í™˜"""
    found = set()
    for tag in SYNONYM_GROUPS.keys():
        if text_has_tag(text, tag):
            found.add(tag)
    return found


# âœ… í•©ë™ì¡°ì‚¬ ê´€ë ¨ ë§¤ë‰´ì–¼ Q&A (íƒœê·¸ ê¸°ë°˜ ë§¤ì¹­)
FAQ_DATA = [
    {
        "name": "í•©ë™ì¡°ì‚¬ ì‹¤ì‹œ íŒë‹¨ ê¸°ì¤€",
        "tags": ["JOINT_INVESTIGATION", "WHEN"],
        "answer": (
            "[ëŒ€í…ŒëŸ¬ í•©ë™ì¡°ì‚¬ ì‹¤ì‹œ íŒë‹¨ ê¸°ì¤€]\n"
            "\n"
            "â–  ê¸°ë³¸ ì›ì¹™\n"
            "- ë‹¨ì¼ ê¸°ê´€(ê²½ì°°Â·ì†Œë°© ë“±)ë§Œìœ¼ë¡œ ìƒí™© íŒë‹¨ì´ ê³¤ë€í•˜ê±°ë‚˜\n"
            "  í…ŒëŸ¬ ê°€ëŠ¥ì„±ì„ ì‰½ê²Œ ë°°ì œí•˜ê¸° ì–´ë ¤ìš´ ê²½ìš° í•©ë™ì¡°ì‚¬ë¥¼ ê²€í† í•©ë‹ˆë‹¤.\n"
            "\n"
            "â–  í•©ë™ì¡°ì‚¬ ê²€í†  íŠ¸ë¦¬ê±°(ì˜ˆì‹œ)\n"
            "1. í­ë°œë¬¼Â·ì´ê¸°Â·í™”í•™ë¬¼ì§ˆ ë“± ê³ ìœ„í—˜ ì˜ì‹¬ë¬¼ì´ í™•ì¸ë˜ì—ˆê±°ë‚˜ ê°€ëŠ¥ì„±ì´ ë†’ì€ ê²½ìš°\n"
            "2. í…ŒëŸ¬ ì¡°ì§Â·ê·¹ë‹¨ì£¼ì˜ ë‹¨ì²´ì™€ ì—°ê³„ëœ ìƒì§•Â·ë¬¸êµ¬Â·ì˜ìƒ ë“±ì´ ë°œê²¬ëœ ê²½ìš°\n"
            "3. ê³µí•­Â·ì² ë„ì—­Â·í•­ë§ŒÂ·ì •ë¶€ì²­ì‚¬ ë“± êµ­ê°€ ì¤‘ìš”ì‹œì„¤ì„ ëŒ€ìƒìœ¼ë¡œ í•œ ìœ„í˜‘ ì •í™©ì´ ìˆëŠ” ê²½ìš°\n"
            "4. ì‚¬ì „ì— í˜‘ë°•Â·ì˜ˆê³  ê¸€(ì˜¨ë¼ì¸, ë¬¸ì ë“±)ì´ ìˆì—ˆê³ , ì‹¤ì œ í˜„ì¥ ì§•í›„ê°€ ë’¤ë”°ë¥´ëŠ” ê²½ìš°\n"
            "5. ë‹¤ìˆ˜ ì¸ëª… í”¼í•´ê°€ ìš°ë ¤ë˜ëŠ” ê³„íšì  ìœ„í˜‘ì´ ì˜ì‹¬ë˜ëŠ” ê²½ìš°\n"
            "6. êµ­ì •ì›Â·êµ°Â·ê²½ì°°Â·ì†Œë°©Â·ì§€ìì²´ ë“± ë³µìˆ˜ ê¸°ê´€ì˜ ì •ë³´Â·ì—­ëŸ‰ì„ ì¢…í•©í•  í•„ìš”ê°€ ìˆëŠ” ê²½ìš°\n"
            "\n"
            "â€» ë³¸ ê¸°ì¤€ì€ ì°¸ê³ ìš© ì˜ˆì‹œì´ë©°, ì‹¤ì œ í•©ë™ì¡°ì‚¬ ì‹¤ì‹œ ì—¬ë¶€ëŠ” ì§€íœ˜ë¶€Â·ê´€í•  ê¸°ê´€ì˜ íŒë‹¨ì— ë”°ë¦…ë‹ˆë‹¤.\n"
            "â€» ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ë°˜ë“œì‹œ ì†Œì† ê¸°ê´€ì˜ ê³µì‹ ì§€ì¹¨ê³¼ ì§€íœ˜ë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤."
        ),
    },
    {
        "name": "í•©ë™ì¡°ì‚¬ ë‹¨ê³„ë³„ ì ˆì°¨",
        "tags": ["JOINT_INVESTIGATION", "PROCEDURE"],
        "answer": (
            "[ëŒ€í…ŒëŸ¬ í•©ë™ì¡°ì‚¬ ë‹¨ê³„ë³„ ì ˆì°¨]\n"
            "\n"
            "1ë‹¨ê³„. ìƒí™© ì¸ì§€ ë° ì‹ ê³  ì ‘ìˆ˜\n"
            "- ì‹ ê³  ë‚´ìš©, ìœ„ì¹˜, ì‹œê°„, ì²¨ë¶€ ìë£Œ(ì‚¬ì§„Â·ì˜ìƒ) ìš°ì„  í™•ì¸\n"
            "\n"
            "2ë‹¨ê³„. ì´ˆë™ ëŒ€ì‘ ë° í˜„ì¥ í†µì œ\n"
            "- ê´€í•  ê²½ì°°Â·ì†Œë°© ì¶œë™, 1ì°¨ í†µì œì„  ì„¤ì •, ì¸ì›Â·ì°¨ëŸ‰ ì¶œì… í†µì œ\n"
            "\n"
            "3ë‹¨ê³„. í•©ë™ì¡°ì‚¬ë‹¨ í¸ì„± ê²€í† \n"
            "- í…ŒëŸ¬ ê°€ëŠ¥ì„±, ë³µìˆ˜ ê¸°ê´€ ê³µì¡° í•„ìš”ì„± ê²€í†  í›„ í•©ë™ì¡°ì‚¬ë‹¨ êµ¬ì„± ì—¬ë¶€ ê²°ì •\n"
            "\n"
            "4ë‹¨ê³„. í˜„ì¥ í•©ë™ì¡°ì‚¬\n"
            "- EOD, êµ° í­ë°œë¬¼ì²˜ë¦¬, í™”ìƒë°© ëŒ€ì‘íŒ€, ì •ë³´Â·ìˆ˜ì‚¬ ë“± í•©ë™ ì¡°ì‚¬\n"
            "\n"
            "5ë‹¨ê³„. ë¶„ì„ ë° í…ŒëŸ¬ ì—¬ë¶€ ìµœì¢… í‰ê°€\n"
            "- ê³ ì˜ì„±Â·ê³„íšì„±Â·ì¡°ì§ì„± ì—¬ë¶€ì™€ ë°°í›„Â·ì—°ê³„ì„± ì¢…í•© íŒë‹¨\n"
            "\n"
            "6ë‹¨ê³„. ì‚¬í›„ ì¡°ì¹˜ ë° ì¬ë°œë°©ì§€ ëŒ€ì±… ìˆ˜ë¦½\n"
            "- ê²°ê³¼ë³´ê³ ì„œ, ì–¸ë¡  ëŒ€ì‘, ì·¨ì•½ì  ë³´ì™„Â·êµìœ¡Â·í›ˆë ¨ ê³„íš ìˆ˜ë¦½\n"
            "\n"
            "â€» ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ë°˜ë“œì‹œ ì†Œì† ê¸°ê´€ì˜ ê³µì‹ ì§€ì¹¨ê³¼ ì§€íœ˜ë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤."
        ),
    },
    {
        "name": "ì´ˆë™ ëŒ€ì‘ ì²´í¬ë¦¬ìŠ¤íŠ¸",
        "tags": ["INITIAL_RESPONSE"],
        "answer": (
            "[ëŒ€í…ŒëŸ¬ ì˜ì‹¬ìƒí™© ì´ˆë™ ëŒ€ì‘ ì²´í¬ë¦¬ìŠ¤íŠ¸]\n"
            "\n"
            "â–  í˜„ì¥ ë„ì°© ì§í›„\n"
            "- [ ] 1ì°¨ í†µì œì„  ì„¤ì •, ì˜ì‹¬ë¬¼ê³¼ ì¶©ë¶„í•œ ê±°ë¦¬ í™•ë³´\n"
            "- [ ] ì¸ì›Â·ì°¨ëŸ‰ ì¶œì… í†µì œ, ëŒ€í”¼Â·ìš°íšŒ ìœ ë„\n"
            "- [ ] ìµœì´ˆ ë°œê²¬ìÂ·ì‹ ê³ ì ë¶„ë¦¬, ì§„ìˆ  í™•ë³´\n"
            "\n"
            "â–  ì•ˆì „Â·2ì°¨ ìœ„í—˜ ì ê²€\n"
            "- [ ] 2ì°¨ í­ë°œë¬¼ ê°€ëŠ¥ì„± ê³ ë ¤, ì£¼ë³€ ë¹„ì •ìƒ ë¬¼ì²´ í™•ì¸\n"
            "- [ ] í™”í•™Â·ê°€ìŠ¤Â·ë¶„ë§ ë“± íŠ¹ì´ ë¬¼ì§ˆ ìœ ë¬´ í™•ì¸\n"
            "\n"
            "â€» ì´ˆë™ ë‹¨ê³„ì—ì„œëŠ” ì§ì ‘ ì ‘ì´‰Â·í•´ì²´ê°€ ì•„ë‹Œ í†µì œÂ·ë³´ê³ Â·ì•ˆì „ í™•ë³´ê°€ í•µì‹¬ì…ë‹ˆë‹¤.\n"
            "â€» ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ë°˜ë“œì‹œ ì†Œì† ê¸°ê´€ì˜ ê³µì‹ ì§€ì¹¨ê³¼ ì§€íœ˜ë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤."
        ),
    },
]


# âœ… ìƒí™©ë³„ ê´€ê³„ê¸°ê´€ ì—°ë½ì²˜ (íƒœê·¸ ê¸°ë°˜ ìƒí™© ë§¤ì¹­)
SCENARIO_CONTACTS = [
    {
        "id": "rail_explosive",
        "name": "ì² ë„ì—­ í­ë°œë¬¼ ì˜ì‹¬ ìƒí™©",
        # ì² ë„ ê´€ë ¨ + í­ë°œë¬¼ ê´€ë ¨ ê°œë…ì´ ê°™ì´ ë‚˜ì˜¤ë©´ ì´ ìƒí™©ìœ¼ë¡œ ê°„ì£¼
        "required_tags": ["RAIL", "EXPLOSIVE"],
        "contacts": [
            {
                "agency": "ê´€í•  ê²½ì°°ì„œ 112ìƒí™©ì‹¤",
                "role": "í˜„ì¥ ì¶œë™Â·ì´ˆë™ ì¡°ì¹˜",
                "phone": "000-0000-0000",
            },
            {
                "agency": "ì² ë„ê²½ì°°ëŒ€",
                "role": "ì—­ì‚¬ ë‚´ ì¹˜ì•ˆÂ·ìˆ˜ì‚¬ ê³µì¡°",
                "phone": "000-0000-0001",
            },
            {
                "agency": "ì—­ë¬´ì‹¤(ê´€ì œì„¼í„°)",
                "role": "ì—´ì°¨ ìš´í–‰ ì¡°ì •Â·ìŠ¹ê° ì•ˆë‚´",
                "phone": "000-0000-0002",
            },
            {
                "agency": "ì†Œë°©ì„œ 119ì•ˆì „ì„¼í„°",
                "role": "ì¸ëª… êµ¬ì¡°Â·í™”ì¬Â·í™”í•™ ëŒ€ì‘",
                "phone": "000-0000-0003",
            },
        ],
    },
    {
        "id": "airport_explosive",
        "name": "ê³µí•­ ìˆ˜í•˜ë¬¼ í­ë°œë¬¼ ì˜ì‹¬ ìƒí™©",
        "required_tags": ["AIRPORT", "EXPLOSIVE"],
        "contacts": [
            {
                "agency": "ê³µí•­ê²½ì°°ëŒ€ ìƒí™©ì‹¤",
                "role": "ê³µí•­ ì¹˜ì•ˆÂ·í˜„ì¥ í†µì œ",
                "phone": "000-0000-0010",
            },
            {
                "agency": "ê³µí•­ ë³´ì•ˆê²€ìƒ‰íŒ€",
                "role": "ìˆ˜í•˜ë¬¼ ì¬ê²€ìƒ‰Â·ë³´ì•ˆ êµ¬ì—­ í†µì œ",
                "phone": "000-0000-0011",
            },
            {
                "agency": "ê´€í•  ì†Œë°©ì„œ",
                "role": "í™”ì¬Â·í­ë°œÂ·ì¸ëª… êµ¬ì¡°",
                "phone": "000-0000-0012",
            },
        ],
    },
    {
        "id": "harbor_suspect",
        "name": "í•­ë§Œ ì»¨í…Œì´ë„ˆ ì˜ì‹¬ë¬¼ ìƒí™©",
        "required_tags": ["HARBOR", "EXPLOSIVE"],
        "contacts": [
            {
                "agency": "í•­ë§Œê²½ì°°ì„œ ìƒí™©ì‹¤",
                "role": "í•­ë§Œ êµ¬ì—­ ì¹˜ì•ˆÂ·ìˆ˜ì‚¬",
                "phone": "000-0000-0100",
            },
            {
                "agency": "í•­ë§Œë³´ì•ˆ ë‹´ë‹¹ë¶€ì„œ",
                "role": "ì¶œì…í†µì œÂ·êµ¬ì—­ ë´‰ì‡„",
                "phone": "000-0000-0101",
            },
            {
                "agency": "ì„¸ê´€(ê´€ì„¸ì²­)",
                "role": "í™”ë¬¼ ê²€ì‚¬Â·í†µê´€ ê´€ë ¨ ì¡°ì¹˜",
                "phone": "000-0000-0102",
            },
        ],
    },
]


def get_best_manual_answer(text):
    """ì‚¬ìš©ì ì…ë ¥ì— ê°€ì¥ ì˜ ë§ëŠ” ë§¤ë‰´ì–¼(Q&A)ì„ íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œ ì„ íƒ"""
    text = normalize_text(text)
    tags_in_text = get_tags_in_text(text)

    best_item = None
    best_score = 0

    for item in FAQ_DATA:
        # ì´ ë§¤ë‰´ì–¼ê³¼ ê´€ë ¨ëœ íƒœê·¸ë“¤
        needed_tags = set(item["tags"])
        # ì‚¬ìš©ì ì…ë ¥ì—ì„œ ì‹¤ì œë¡œ ê°ì§€ëœ íƒœê·¸
        matched_tags = needed_tags.intersection(tags_in_text)
        score = len(matched_tags)

        if score > best_score:
            best_score = score
            best_item = item

    # íƒœê·¸ê°€ í•˜ë‚˜ë„ ì•ˆ ë§ìœ¼ë©´ ë§¤ë‰´ì–¼ì„ êµ³ì´ ë³´ì—¬ì¤„ í•„ìš” ì—†ìŒ
    if best_item is None or best_score == 0:
        return None

    return best_item["answer"]


def get_contact_info(text):
    """ì‚¬ìš©ì ì…ë ¥ì— ë§ëŠ” ìƒí™©ë³„ ì—°ë½ì²˜ë¥¼ íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œ íƒì§€"""
    text = normalize_text(text)
    tags_in_text = get_tags_in_text(text)

    matched_scenarios = []

    for scenario in SCENARIO_CONTACTS:
        required = set(scenario["required_tags"])
        # required íƒœê·¸ë“¤ì´ ëª¨ë‘ ì…ë ¥ ì•ˆì— í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ í•´ë‹¹ ìƒí™©ìœ¼ë¡œ íŒë‹¨
        if required.issubset(tags_in_text):
            matched_scenarios.append(scenario)

    if not matched_scenarios:
        return None

    lines = []
    for scenario in matched_scenarios:
        lines.append(f"[ìƒí™©ë³„ ê´€ê³„ê¸°ê´€ ë° ë‹´ë‹¹ì ì—°ë½ì²˜] - {scenario['name']}")
        for c in scenario["contacts"]:
            lines.append(
                f"- ê¸°ê´€: {c['agency']} / ì—­í• : {c['role']} / ì—°ë½ì²˜: {c['phone']}"
            )
        lines.append("")

    lines.append("â€» ì‹¤ì œ ì—°ë½ì²˜Â·ë¶€ì„œëª…Â·ë²ˆí˜¸ëŠ” ì†Œì† ê¸°ê´€ ì‚¬ì •ì— ë§ê²Œ ìˆ˜ì •Â·ê´€ë¦¬í•˜ì‹­ì‹œì˜¤.")
    return "\n".join(lines)


def build_answer(user_message):
    """ë§¤ë‰´ì–¼ + ì—°ë½ì²˜ë¥¼ ìì—°ì–´ íƒœê·¸ ê¸°ë°˜ìœ¼ë¡œ ì¡°í•©í•œ ìµœì¢… ë‹µë³€ ìƒì„±"""
    text = user_message.strip()

    manual = get_best_manual_answer(text)
    contacts = get_contact_info(text)

    # ë‘˜ ë‹¤ ìˆëŠ” ê²½ìš°: ë§¤ë‰´ì–¼ + ì—°ë½ì²˜ ê°™ì´ ë³´ì—¬ì£¼ê¸°
    if manual and contacts:
        return manual + "\n\n" + contacts

    # ë§¤ë‰´ì–¼ë§Œ ìˆëŠ” ê²½ìš°
    if manual:
        return manual

    # ì—°ë½ì²˜ë§Œ ìˆëŠ” ê²½ìš°
    if contacts:
        return contacts

    # ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê¸°ë³¸ ì•ˆë‚´ë§Œ
    return (
        "ëŒ€í…ŒëŸ¬ í•©ë™ì¡°ì‚¬ ê´€ë ¨ ì§ˆë¬¸ìœ¼ë¡œ ì´í•´í–ˆìŠµë‹ˆë‹¤.\n"
        "ì˜ˆë¥¼ ë“¤ì–´ ë‹¤ìŒê³¼ ê°™ì´ ì§ˆë¬¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤:\n"
        "- ëŒ€í…ŒëŸ¬ í•©ë™ì¡°ì‚¬ëŠ” ì–¸ì œ í•´ì•¼ í•˜ë‚˜ìš”?\n"
        "- í•©ë™ì¡°ì‚¬ ë‹¨ê³„ë³„ ì ˆì°¨ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.\n"
        "- ì—­ì—ì„œ ìˆ˜ìƒí•œ ê°€ë°©ì´ ë°œê²¬ë˜ì—ˆì„ ë•Œ ëˆ„êµ¬ì—ê²Œ ì—°ë½í•´ì•¼ í•˜ë‚˜ìš”?\n"
        "- í•­ë§Œ ì»¨í…Œì´ë„ˆ ì˜ì‹¬ ìƒí™©ì¼ ë•Œ ì—°ë½ì²˜ë¥¼ ì•Œê³  ì‹¶ì–´ìš”.\n\n"
        "ì§ˆë¬¸ì„ ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ì ì–´ì£¼ì‹œë©´, ì¤€ë¹„ëœ ë§¤ë‰´ì–¼ê³¼ ìƒí™©ë³„ ì—°ë½ì²˜ë¥¼ í•¨ê»˜ ì•ˆë‚´í•´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.\n"
        "â€» ì‹¤ì œ ìƒí™©ì—ì„œëŠ” ë°˜ë“œì‹œ ì†Œì† ê¸°ê´€ì˜ ê³µì‹ ì§€ì¹¨ê³¼ ì§€íœ˜ë¥¼ ë”°ë¥´ì‹­ì‹œì˜¤."
    )


# ğŸ” ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ê´€ë ¨ ë¼ìš°íŠ¸
@app.route("/login", methods=["GET", "POST"])
def login():
    if request.method == "GET":
        return send_from_directory(".", "login.html")

    username = request.form.get("username", "").strip()
    password = request.form.get("password", "").strip()

    if username in ALLOWED_USERS and ALLOWED_USERS[username] == password:
        session["logged_in"] = True
        session["username"] = username
        return redirect(url_for("index"))
    else:
        return redirect(url_for("login") + "?error=1")


@app.route("/logout")
def logout():
    session.clear()
    return redirect(url_for("login"))


# ğŸ”’ ë©”ì¸ í™”ë©´ (ë¡œê·¸ì¸ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ)
@app.route("/")
def index():
    if not session.get("logged_in"):
        return redirect(url_for("login"))
    return send_from_directory(".", "index.html")


@app.route("/script.js")
def script():
    return send_from_directory(".", "script.js")


# ğŸ’¬ ì±—ë´‡ API
@app.route("/api/chat", methods=["POST"])
def chat():
    if not session.get("logged_in"):
        return jsonify({"reply": "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."}), 401

    data = request.get_json(force=True)
    user_message = data.get("message", "").strip()

    if not user_message:
        return jsonify({"reply": "ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."})

    reply = build_answer(user_message)
    return jsonify({"reply": reply})


if __name__ == "__main__":
    # ë¡œì»¬ ê°œë°œìš© ì‹¤í–‰
    app.run(host="0.0.0.0", port=5000, debug=True)
